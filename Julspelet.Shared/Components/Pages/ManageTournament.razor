@page "/manage-tournament/{tournamentId}"
@using Julspelet.Shared.Models
@using Julspelet.Shared.Services
@using QRCoder
@using System.IO
@inject TournamentService TournamentService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Manage Tournament - Julspelet</PageTitle>

@if (_tournament == null)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
        <MudAlert Severity="Severity.Error">Tournament not found!</MudAlert>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <MudPaper Elevation="3" Class="pa-6" Style="background: linear-gradient(135deg, #1e4620 0%, #2d5a2f 100%);">
            <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Warning" Class="mb-2" Style="font-family: 'Mountains of Christmas', cursive;">
                üéÑ @_tournament.Name üéÑ
            </MudText>
            <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Success" Class="mb-4">
                Game Master: @_tournament.GameMaster.Name
            </MudText>

            <!-- Tournament Status -->
            <MudChip T="string" Color="@GetStatusColor()" Size="Size.Large" Class="mb-4">
                Status: @GetStatusText()
            </MudChip>
            
            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">@_statusMessage</MudAlert>
            }
        </MudPaper>

        <!-- Pre-Tournament: Player Registration -->
        @if (!_tournament.HasStarted)
        {
            <MudPaper Elevation="2" Class="pa-6 mt-4">
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">
                    üë• Registered Players (@_tournament.RegisteredPlayers.Count / @_tournament.MaxPlayers)
                </MudText>
                
                @if (_tournament.RegisteredPlayers.Any())
                {
                    <MudList T="string" Dense="true">
                        @foreach (var player in _tournament.RegisteredPlayers)
                        {
                            <MudListItem T="string">
                                <MudText>üéÖ @player.Name</MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">Waiting for players to join...</MudAlert>
                }

                <MudDivider Class="my-4" />

                <!-- QR Code and Shareable Link Section -->
                <MudPaper Elevation="1" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #fffacd 0%, #fff8dc 100%); border: 2px dashed #2d5a2f;">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Align="Align.Center" Class="mb-3">
                        üì± Scan to Join Tournament üì±
                    </MudText>
                    
                    <div style="text-align: center; margin-bottom: 16px;">
                        @if (!string.IsNullOrEmpty(_qrCodeBase64))
                        {
                            <img src="@_qrCodeBase64" alt="QR Code" style="max-width: 250px; border: 4px solid white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);" />
                        }
                    </div>
                    
                    <MudText Typo="Typo.body2" Color="Color.Info" Align="Align.Center" Class="mb-2">
                        <strong>Or share this link:</strong>
                    </MudText>
                    
                    <MudTextField @bind-Value="_joinUrl" 
                                  ReadOnly="true" 
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                                  OnAdornmentClick="CopyJoinUrlToClipboard"
                                  Class="mb-2"
                                  Style="background-color: white;" />
                    
                    @if (_showCopyMessage)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Success" Align="Align.Center">
                            ‚úÖ Link copied to clipboard!
                        </MudText>
                    }
                    
                    <MudText Typo="Typo.caption" Color="Color.Info" Align="Align.Center" Class="mt-2">
                        Players can scan the QR code or click the link to join instantly!
                    </MudText>
                </MudPaper>

                @if (_tournament.CanStart)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               OnClick="StartTournament"
                               FullWidth="true">
                        Start Tournament!
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        Need at least @_tournament.MinPlayers players to start (currently @_tournament.RegisteredPlayers.Count)
                    </MudAlert>
                }
            </MudPaper>
        }
        else
        {
            <!-- Tournament Bracket View -->
            <MudPaper Elevation="2" Class="pa-6 mt-4">
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">
                    üèÜ Tournament Bracket - @_tournament.CurrentRound
                </MudText>

                @if (_tournament.IsCompleted && _tournament.Winner != null)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        <MudText Typo="Typo.h4" Align="Align.Center">
                            üéâ Champion: @_tournament.Winner.Name! üéâ
                        </MudText>
                    </MudAlert>
                }

                <!-- Display matches by round -->
                @foreach (var round in GetRoundsToDisplay())
                {
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4 mb-2">
                        @round
                    </MudText>
                    
                    var matches = TournamentService.GetMatchesForRound(_tournament.Id, round);
                    
                    <MudGrid>
                        @foreach (var match in matches)
                        {
                            <MudItem xs="12" md="6">
                                <MudCard Outlined="true" Class="mb-2">
                                    <MudCardContent>
                                        <MudText Typo="Typo.h6" Color="Color.Primary">
                                            Match @match.MatchNumber
                                        </MudText>
                                        
                                        @if (match.Players.Count >= 2)
                                        {
                                            <MudText>
                                                üéÖ @match.Players[0].Name 
                                                @if (match.IsCompleted)
                                                {
                                                    <text>(@match.Players[0].ScoreCard.GetTotalScore())</text>
                                                    @if (match.Winner?.Id == match.Players[0].Id)
                                                    {
                                                        <text> ‚úÖ</text>
                                                    }
                                                }
                                            </MudText>
                                            <MudText Class="mb-2">
                                                üéÖ @match.Players[1].Name
                                                @if (match.IsCompleted)
                                                {
                                                    <text>(@match.Players[1].ScoreCard.GetTotalScore())</text>
                                                    @if (match.Winner?.Id == match.Players[1].Id)
                                                    {
                                                        <text> ‚úÖ</text>
                                                    }
                                                }
                                            </MudText>
                                        }
                                        
                                        @if (match.IsCompleted)
                                        {
                                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Completed</MudChip>
                                        }
                                        else if (match.StartedAt != null)
                                        {
                                            <MudChip T="string" Color="Color.Info" Size="Size.Small">In Progress</MudChip>
                                            <MudButton Variant="Variant.Filled" 
                                                       Color="Color.Primary"
                                                       Size="Size.Small"
                                                       Class="mt-2"
                                                       OnClick="@(() => NavigateToMatch(match.Id))">
                                                View Match
                                            </MudButton>
                                        }
                                        else if (round == _tournament.CurrentRound)
                                        {
                                            <MudButton Variant="Variant.Filled" 
                                                       Color="Color.Success"
                                                       Size="Size.Small"
                                                       OnClick="@(() => StartMatch(match.Id))">
                                                Start Match
                                            </MudButton>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Color="Color.Default" Size="Size.Small">Not Started</MudChip>
                                        }
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudPaper>
        }

        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Default"
                   Class="mt-4"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="@(() => NavigationManager.NavigateTo("/tournament-lobby"))">
            Back to Lobby
        </MudButton>
    </MudContainer>
}

@code {
    [Parameter]
    public string TournamentId { get; set; } = "";

    private Tournament? _tournament;
    private string _statusMessage = "";
    private System.Threading.Timer? _refreshTimer;
    private string _qrCodeBase64 = "";
    private string _joinUrl = "";
    private bool _showCopyMessage = false;

    protected override void OnInitialized()
    {
        // Subscribe to tournament events
        TournamentService.PlayerJoined += OnPlayerJoined;
        TournamentService.TournamentStarted += OnTournamentStarted;
        TournamentService.MatchCompleted += OnMatchCompleted;
        TournamentService.RoundAdvanced += OnRoundAdvanced;
        TournamentService.TournamentCompleted += OnTournamentCompleted;
        
        // Auto-refresh every 2 seconds
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                LoadTournament();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    protected override void OnParametersSet()
    {
        LoadTournament();
    }

    private void LoadTournament()
    {
        if (!string.IsNullOrEmpty(TournamentId))
        {
            _tournament = TournamentService.GetTournament(TournamentId);
            GenerateQrCode();
        }
    }

    /// <summary>
    /// Generates a QR code for the tournament join URL.
    /// Uses QRCoder library to create a PNG image encoded as base64.
    /// </summary>
    private void GenerateQrCode()
    {
        if (_tournament == null) return;
        
        // Get the base URL from NavigationManager and create the join URL
        var baseUri = NavigationManager.BaseUri;
        _joinUrl = $"{baseUri}tournament-lobby/{_tournament.Id}";
        
        // Generate QR code using QRCoder library
        using (var qrGenerator = new QRCodeGenerator())
        {
            var qrCodeData = qrGenerator.CreateQrCode(_joinUrl, QRCodeGenerator.ECCLevel.Q);
            using (var qrCode = new PngByteQRCode(qrCodeData))
            {
                var qrCodeBytes = qrCode.GetGraphic(20);
                _qrCodeBase64 = $"data:image/png;base64,{Convert.ToBase64String(qrCodeBytes)}";
            }
        }
    }

    /// <summary>
    /// Copies the join URL to the clipboard using JavaScript interop.
    /// Shows a temporary success message to the user.
    /// </summary>
    private async Task CopyJoinUrlToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _joinUrl);
            _showCopyMessage = true;
            StateHasChanged();
            
            // Hide the message after 3 seconds
            await Task.Delay(3000);
            _showCopyMessage = false;
            StateHasChanged();
        }
        catch
        {
            // Clipboard API might not be available in some contexts
        }
    }

    private void StartTournament()
    {
        if (TournamentService.StartTournament(TournamentId))
        {
            _statusMessage = "Tournament started! Matches have been generated.";
            LoadTournament();
        }
    }

    private void StartMatch(string matchId)
    {
        if (TournamentService.StartMatch(TournamentId, matchId))
        {
            NavigateToMatch(matchId);
        }
    }

    private void NavigateToMatch(string matchId)
    {
        NavigationManager.NavigateTo($"/tournament-match/{TournamentId}/{matchId}");
    }

    private List<TournamentRound> GetRoundsToDisplay()
    {
        var rounds = new List<TournamentRound>();
        
        if (_tournament == null) return rounds;
        
        // Show all rounds that have matches
        foreach (TournamentRound round in Enum.GetValues(typeof(TournamentRound)))
        {
            if (round == TournamentRound.Completed) continue;
            
            if (_tournament.Matches.Any(m => m.Round == round))
            {
                rounds.Add(round);
            }
        }
        
        return rounds;
    }

    private Color GetStatusColor()
    {
        if (_tournament == null) return Color.Default;
        
        if (_tournament.IsCompleted) return Color.Success;
        if (_tournament.HasStarted) return Color.Info;
        return Color.Warning;
    }

    private string GetStatusText()
    {
        if (_tournament == null) return "Unknown";
        
        if (_tournament.IsCompleted) return "Completed";
        if (_tournament.HasStarted) return $"In Progress - {_tournament.CurrentRound}";
        return "Waiting for Players";
    }

    private void OnPlayerJoined(Tournament tournament, Player player)
    {
        if (tournament.Id == TournamentId)
        {
            InvokeAsync(() =>
            {
                LoadTournament();
                StateHasChanged();
            });
        }
    }

    private void OnTournamentStarted(Tournament tournament)
    {
        if (tournament.Id == TournamentId)
        {
            InvokeAsync(() =>
            {
                LoadTournament();
                StateHasChanged();
            });
        }
    }

    private void OnMatchCompleted(Tournament tournament, Match match)
    {
        if (tournament.Id == TournamentId)
        {
            InvokeAsync(() =>
            {
                LoadTournament();
                StateHasChanged();
            });
        }
    }

    private void OnRoundAdvanced(Tournament tournament, TournamentRound round)
    {
        if (tournament.Id == TournamentId)
        {
            InvokeAsync(() =>
            {
                _statusMessage = $"Advanced to {round}!";
                LoadTournament();
                StateHasChanged();
            });
        }
    }

    private void OnTournamentCompleted(Tournament tournament)
    {
        if (tournament.Id == TournamentId)
        {
            InvokeAsync(() =>
            {
                LoadTournament();
                StateHasChanged();
            });
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        TournamentService.PlayerJoined -= OnPlayerJoined;
        TournamentService.TournamentStarted -= OnTournamentStarted;
        TournamentService.MatchCompleted -= OnMatchCompleted;
        TournamentService.RoundAdvanced -= OnRoundAdvanced;
        TournamentService.TournamentCompleted -= OnTournamentCompleted;
    }
}
