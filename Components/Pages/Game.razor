@page "/game"
@using Julspelet.Services
@using Julspelet.Models
@using Microsoft.JSInterop
@inject GameService GameService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

@* 
    Game Component - Main gameplay page for Yatzy
    Handles dice rolling, holding dice, scoring, and turn progression.
    Demonstrates Blazor's component lifecycle and state management.
*@

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (!GameService.GameState.IsGameStarted)
    {
        @* Redirect to home if game hasn't started *@
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            No game in progress. Redirecting to player setup...
        </MudAlert>
    }
    else if (GameService.GameState.IsGameComplete)
    {
        @* Game Over Screen *@
        <MudPaper Elevation="3" Class="pa-6">
            <div class="text-center mb-6">
                <MudText Typo="Typo.h3" Color="Color.Success" Class="mb-2">
                    üéÑ Game Over! üéÖ
                </MudText>
                
                @{
                    var winners = GameService.GameState.GetWinners();
                    if (winners.Count == 1)
                    {
                        <MudText Typo="Typo.h4" Class="mb-2">
                            üèÜ Winner: @winners[0].Name! üèÜ
                        </MudText>
                        <MudText Typo="Typo.h5" Color="Color.Secondary">
                            Final Score: @winners[0].TotalScore points
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.h4" Class="mb-2">
                            üèÜ It's a Tie! üèÜ
                        </MudText>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">
                            Winners: @string.Join(", ", winners.Select(w => w.Name))
                        </MudText>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">
                            Final Score: @winners[0].TotalScore points each
                        </MudText>
                    }
                }
            </div>

            @* Final Standings Table *@
            <MudText Typo="Typo.h6" Class="mb-3 text-center">Final Standings</MudText>
            <MudSimpleTable Elevation="0" Class="mb-4">
                <thead>
                    <tr>
                        <th class="text-center">Rank</th>
                        <th>Player</th>
                        <th class="text-right">Upper</th>
                        <th class="text-right">Bonus</th>
                        <th class="text-right">Lower</th>
                        <th class="text-right"><strong>Total</strong></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var rank = 1;
                        var sortedPlayers = GameService.GameState.Players.OrderByDescending(p => p.TotalScore).ToList();
                    }
                    @foreach (var player in sortedPlayers)
                    {
                        <tr class="@(winners.Contains(player) ? "winner-row" : "")">
                            <td class="text-center">
                                @if (rank == 1)
                                {
                                    <span>ü•á</span>
                                }
                                else if (rank == 2)
                                {
                                    <span>ü•à</span>
                                }
                                else if (rank == 3)
                                {
                                    <span>ü•â</span>
                                }
                                else
                                {
                                    @rank
                                }
                            </td>
                            <td><strong>@player.Name</strong></td>
                            <td class="text-right">@player.ScoreCard.GetUpperSectionTotal()</td>
                            <td class="text-right">@player.ScoreCard.GetUpperSectionBonus()</td>
                            <td class="text-right">@player.ScoreCard.GetLowerSectionTotal()</td>
                            <td class="text-right"><strong>@player.TotalScore</strong></td>
                        </tr>
                        rank++;
                    }
                </tbody>
            </MudSimpleTable>

            <div class="text-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large"
                           OnClick="NewGame"
                           StartIcon="@Icons.Material.Filled.Refresh">
                    New Game
                </MudButton>
            </div>
        </MudPaper>
    }
    else
    {
        @* Main Game Interface *@
        <MudGrid>
            @* Left Column - Game Area *@
            <MudItem xs="12" md="8">
                @* Current Player Info *@
                <MudPaper Elevation="3" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h5" Color="Color.Primary">
                        Current Turn: @GameService.GameState.GetCurrentPlayer()?.Name
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        Roll @GameService.GameState.RollsThisTurn of @GameState.MaxRollsPerTurn
                    </MudText>
                    
                    @if (GameService.GameState.RollsThisTurn == 0)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            Click "Start Turn" to roll the dice!
                        </MudAlert>
                    }
                </MudPaper>

                @* Dice Display *@
                <MudPaper Elevation="3" Class="pa-6 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-4 text-center">Dice</MudText>
                    
                    <div class="dice-container">
                        @for (int i = 0; i < GameService.GameState.DiceSet.Dice.Count; i++)
                        {
                            var index = i; // Capture for lambda
                            var die = GameService.GameState.DiceSet.Dice[i];
                            var canHold = GameService.GameState.RollsThisTurn > 0 && 
                                         GameService.GameState.RollsThisTurn < GameState.MaxRollsPerTurn;

                            <div class="dice-wrapper">
                                <MudPaper Elevation="@(die.IsHeld ? 8 : 2)" 
                                          Class="@GetDiceClass(die)"
                                          @onclick="@(() => ToggleDie(index))"
                                          Style="@(canHold ? "cursor: pointer;" : "cursor: default;")"
                                          data-dice-index="@index">
                                    <div class="dice-value @(die.IsRolling ? "rolling" : "")" data-value="@die.Value">
                                        @{
                                            var displayValue = die.IsRolling && _intermediateDiceValues.ContainsKey(index)
                                                ? _intermediateDiceValues[index]
                                                : die.Value;
                                        }
                                        @GetDiceEmoji(displayValue)
                                    </div>
                                </MudPaper>
                                @if (die.IsHeld)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mt-2">Held</MudChip>
                                }
                            </div>
                        }
                    </div>

                    @if (GameService.GameState.RollsThisTurn > 0)
                    {
                        <MudText Typo="Typo.caption" Class="text-center mt-3" Color="Color.Info">
                            Click on dice to hold them before your next roll
                        </MudText>
                    }
                </MudPaper>

                @* Action Buttons *@
                <MudPaper Elevation="3" Class="pa-4">
                    <div class="d-flex gap-3">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   Size="Size.Large"
                                   FullWidth="true"
                                   OnClick="RollDice"
                                   Disabled="!GameService.GameState.CanRoll()"
                                   StartIcon="@Icons.Material.Filled.Casino">
                            @(GameService.GameState.RollsThisTurn == 0 ? "Start Turn" : "Roll Again")
                        </MudButton>
                    </div>
                    
                    @if (!GameService.GameState.CanRoll() && GameService.GameState.RollsThisTurn > 0)
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-3">
                            No more rolls! Choose a category to score.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            @* Right Column - Scoring Interface *@
            <MudItem xs="12" md="4">
                @* Available Categories *@
                @if (GameService.GameState.RollsThisTurn > 0)
                {
                    <MudPaper Elevation="3" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h6" Class="mb-3">Score This Turn</MudText>
                        
                        @{
                            var availableCategories = GameService.GetAvailableCategories();
                            var currentPlayer = GameService.GameState.GetCurrentPlayer();
                        }

                        @if (availableCategories.Any())
                        {
                            <MudList T="string" Dense="true">
                                @foreach (var category in availableCategories)
                                {
                                    var potentialScore = GameService.GetPotentialScore(category);
                                    
                                    <MudListItem T="string" OnClick="@(() => SubmitScore(category))">
                                        <div class="d-flex justify-space-between align-center">
                                            <MudText Typo="Typo.body2">@category.GetDisplayName()</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="@(potentialScore > 0 ? Color.Success : Color.Default)">
                                                @potentialScore pts
                                            </MudChip>
                                        </div>
                                    </MudListItem>
                                    <MudDivider />
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">
                                All categories have been scored!
                            </MudAlert>
                        }
                    </MudPaper>
                }

                @* Current Player Scorecard *@
                <MudPaper Elevation="3" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        @GameService.GameState.GetCurrentPlayer()?.Name's Scorecard
                    </MudText>
                    
                    @{
                        var player = GameService.GameState.GetCurrentPlayer();
                        if (player != null)
                        {
                            <MudSimpleTable Dense="true" Hover="true" Class="scorecard-table">
                                <tbody>
                                    @* Upper Section *@
                                    <tr class="section-header">
                                        <td colspan="2"><strong>Upper Section</strong></td>
                                    </tr>
                                    @foreach (var category in GetUpperCategories())
                                    {
                                        <tr>
                                            <td>@category.GetDisplayName()</td>
                                            <td class="text-right">
                                                @if (player.ScoreCard.IsCategoryScored(category))
                                                {
                                                    <strong>@player.ScoreCard.Scores[category]</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                    <tr class="subtotal-row">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetUpperSectionTotal()</strong></td>
                                    </tr>
                                    <tr class="bonus-row">
                                        <td><strong>Bonus (63+)</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetUpperSectionBonus()</strong></td>
                                    </tr>

                                    @* Lower Section *@
                                    <tr class="section-header">
                                        <td colspan="2"><strong>Lower Section</strong></td>
                                    </tr>
                                    @foreach (var category in GetLowerCategories())
                                    {
                                        <tr>
                                            <td>@category.GetDisplayName()</td>
                                            <td class="text-right">
                                                @if (player.ScoreCard.IsCategoryScored(category))
                                                {
                                                    <strong>@player.ScoreCard.Scores[category]</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                    <tr class="subtotal-row">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetLowerSectionTotal()</strong></td>
                                    </tr>

                                    @* Total *@
                                    <tr class="total-row">
                                        <td><strong>TOTAL</strong></td>
                                        <td class="text-right"><strong>@player.TotalScore</strong></td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                    }
                </MudPaper>

                @* All Players Scores *@
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">All Players</MudText>
                    
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th class="text-right">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var player in GameService.GameState.Players.OrderByDescending(p => p.TotalScore))
                            {
                                <tr class="@(player.IsCurrentTurn ? "current-player-row" : "")">
                                    <td>
                                        @if (player.IsCurrentTurn)
                                        {
                                            <strong>‚ñ∂ @player.Name</strong>
                                        }
                                        else
                                        {
                                            @player.Name
                                        }
                                    </td>
                                    <td class="text-right">
                                        <strong>@player.TotalScore</strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .dice-container {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin: 1rem 0;
        perspective: 1000px;
    }

    .dice-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        perspective: 1000px;
    }

    .dice {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 18px;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 50%, #e8e8e8 100%);
        position: relative;
        overflow: visible;
        border: 2px solid #d0d0d0;
        box-shadow: 
            inset -3px -3px 8px rgba(0, 0, 0, 0.15),
            inset 3px 3px 8px rgba(255, 255, 255, 0.9),
            0 6px 12px rgba(0, 0, 0, 0.2),
            0 2px 4px rgba(0, 0, 0, 0.1);
        transform-style: preserve-3d;
    }

    .dice::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
        pointer-events: none;
    }

    .dice-held {
        background: linear-gradient(135deg, #fff9e6 0%, #ffe8a1 50%, #ffd700 100%) !important;
        border: 3px solid #ffb700;
        box-shadow: 
            inset -3px -3px 8px rgba(139, 90, 0, 0.2),
            inset 3px 3px 8px rgba(255, 255, 200, 0.9),
            0 0 20px rgba(255, 193, 7, 0.6),
            0 6px 12px rgba(255, 193, 7, 0.3),
            0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .dice:not(.dice-rolling):hover {
        transform: scale(1.05) translateY(-2px);
        box-shadow: 
            inset -3px -3px 8px rgba(0, 0, 0, 0.15),
            inset 3px 3px 8px rgba(255, 255, 255, 0.9),
            0 8px 16px rgba(0, 0, 0, 0.25),
            0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .dice-value {
        font-size: 5.5rem;
        line-height: 1;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        transition: transform 0.2s ease;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        position: relative;
        z-index: 1;
        padding: 2px;
    }

    .scorecard-table {
        font-size: 0.875rem;
    }

    .scorecard-table td {
        padding: 0.5rem;
    }

    .section-header {
        background: #f5f5f5;
    }

    .subtotal-row {
        border-top: 1px solid #ddd;
        background: #fafafa;
    }

    .bonus-row {
        background: #fff3cd;
    }

    .total-row {
        border-top: 2px solid #333;
        background: #e3f2fd;
        font-size: 1.1rem;
    }

    .current-player-row {
        background: #e8f5e9;
        font-weight: 500;
    }

    .winner-row {
        background: #fff3cd;
        font-weight: 600;
    }

    .text-muted {
        color: #999;
    }
</style>

@code {
    /// <summary>
    /// Subscribes to game state changes when component initializes.
    /// This ensures the UI updates automatically when the game state changes.
    /// </summary>
    protected override void OnInitialized()
    {
        GameService.OnGameStateChanged += StateHasChanged;
    }

    /// <summary>
    /// Checks if game is started after first render and redirects if needed.
    /// Using OnAfterRender ensures the game state is properly set before checking.
    /// </summary>
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !GameService.GameState.IsGameStarted)
        {
            Navigation.NavigateTo("/");
        }
    }

    /// <summary>
    /// Unsubscribes from events when component is disposed to prevent memory leaks.
    /// </summary>
    public void Dispose()
    {
        GameService.OnGameStateChanged -= StateHasChanged;
        StopSpriteStripAnimation();
    }

    private Random _animRandom = new Random();
    private System.Threading.Timer? _spriteTimer;
    private Dictionary<int, int> _intermediateDiceValues = new Dictionary<int, int>();

    /// <summary>
    /// Rolls the dice for the current turn with enhanced sprite strip animation.
    /// Uses JavaScript interop to coordinate animation timing with actual face changes.
    /// </summary>
    private async Task RollDice()
    {
        // Set all non-held dice to rolling state
        var diceToRoll = GameService.GameState.DiceSet.Dice.Where(d => !d.IsHeld).ToList();
        var rollingIndices = GameService.GameState.DiceSet.Dice
            .Select((die, index) => new { die, index })
            .Where(x => !x.die.IsHeld)
            .Select(x => x.index)
            .ToList();
        
        foreach (var die in diceToRoll)
        {
            die.IsRolling = true;
        }
        StateHasChanged();

        try
        {
            // Start the sprite strip animation with rapid face changes
            StartSpriteStripAnimation(rollingIndices);
            
            // Start the CSS animation
            await JSRuntime.InvokeVoidAsync("diceAnimation.startRoll", diceToRoll.Count);
            
            // Roll the dice to get final values (but don't show yet)
            GameService.RollDice();
            
            // Wait for animation to complete
            await JSRuntime.InvokeVoidAsync("diceAnimation.waitForAnimation");
            
            // Stop sprite animation
            StopSpriteStripAnimation();
            
            // Check for high rolls (5s and 6s) and celebrate
            var highRollIndices = GameService.GameState.DiceSet.Dice
                .Select((die, index) => new { die, index })
                .Where(x => !x.die.IsHeld && (x.die.Value == 5 || x.die.Value == 6))
                .Select(x => x.index)
                .ToArray();
            
            if (highRollIndices.Any())
            {
                await JSRuntime.InvokeVoidAsync("diceAnimation.celebrateHighRoll", (object)highRollIndices);
            }
        }
        catch (JSException ex)
        {
            // Handle JavaScript errors gracefully
            Console.WriteLine($"Animation error: {ex.Message}");
            StopSpriteStripAnimation();
        }
        finally
        {
            // Clear rolling state and intermediate values
            foreach (var die in diceToRoll)
            {
                die.IsRolling = false;
            }
            _intermediateDiceValues.Clear();
            StateHasChanged();
        }
    }

    /// <summary>
    /// Starts rapid face value changes for sprite strip effect with deceleration.
    /// Creates a realistic settling effect by progressively slowing down face changes.
    /// </summary>
    private void StartSpriteStripAnimation(List<int> diceIndices)
    {
        var startTime = DateTime.Now;
        var duration = 600; // 600ms total
        
        _spriteTimer = new System.Threading.Timer(_ =>
        {
            var elapsed = (DateTime.Now - startTime).TotalMilliseconds;
            if (elapsed >= duration)
            {
                return;
            }
            
            // Calculate progress (0.0 to 1.0)
            var progress = elapsed / duration;
            
            // Update intermediate values for rolling dice
            foreach (var index in diceIndices)
            {
                // Use quadratic easing for deceleration
                // Early in animation: frequent changes
                // Late in animation: rare changes
                var changeThreshold = 1.0 - (progress * progress); // Quadratic ease-out
                
                if (_animRandom.NextDouble() < changeThreshold)
                {
                    _intermediateDiceValues[index] = _animRandom.Next(1, 7);
                }
            }
            
            InvokeAsync(StateHasChanged);
        }, null, 0, 16); // ~60fps for smooth animation
    }

    /// <summary>
    /// Stops the sprite strip animation timer.
    /// </summary>
    private void StopSpriteStripAnimation()
    {
        _spriteTimer?.Dispose();
        _spriteTimer = null;
    }

    /// <summary>
    /// Toggles the hold state of a die.
    /// </summary>
    private void ToggleDie(int index)
    {
        // Can only hold dice after first roll and before last roll is complete
        if (GameService.GameState.RollsThisTurn > 0 && 
            GameService.GameState.RollsThisTurn < GameState.MaxRollsPerTurn)
        {
            GameService.ToggleDieHold(index);
            StateHasChanged(); // Explicitly trigger re-render
        }
    }

    /// <summary>
    /// Gets the CSS class for a die based on its held and rolling state.
    /// </summary>
    private string GetDiceClass(Die die)
    {
        var classes = new List<string> { "dice" };
        if (die.IsHeld) classes.Add("dice-held");
        if (die.IsRolling) classes.Add("dice-rolling");
        return string.Join(" ", classes);
    }

    /// <summary>
    /// Returns an emoji representation of the die value.
    /// Uses actual die face emojis for visual appeal.
    /// </summary>
    private string GetDiceEmoji(int value)
    {
        return value switch
        {
            1 => "‚öÄ",
            2 => "‚öÅ",
            3 => "‚öÇ",
            4 => "‚öÉ",
            5 => "‚öÑ",
            6 => "‚öÖ",
            _ => "?"
        };
    }

    /// <summary>
    /// Starts a new game and navigates back to player setup.
    /// </summary>
    private void NewGame()
    {
        GameService.NewGame();
        Navigation.NavigateTo("/");
    }

    /// <summary>
    /// Scores the selected category and moves to next player.
    /// </summary>
    private void SubmitScore(ScoreCategory category)
    {
        GameService.ScoreCategory(category);
        StateHasChanged(); // Explicitly trigger re-render
    }

    /// <summary>
    /// Gets the upper section categories (Ones through Sixes).
    /// </summary>
    private List<ScoreCategory> GetUpperCategories()
    {
        return new List<ScoreCategory>
        {
            ScoreCategory.Ones,
            ScoreCategory.Twos,
            ScoreCategory.Threes,
            ScoreCategory.Fours,
            ScoreCategory.Fives,
            ScoreCategory.Sixes
        };
    }

    /// <summary>
    /// Gets the lower section categories (combinations).
    /// </summary>
    private List<ScoreCategory> GetLowerCategories()
    {
        return new List<ScoreCategory>
        {
            ScoreCategory.OnePair,
            ScoreCategory.TwoPairs,
            ScoreCategory.ThreeOfAKind,
            ScoreCategory.FourOfAKind,
            ScoreCategory.SmallStraight,
            ScoreCategory.LargeStraight,
            ScoreCategory.FullHouse,
            ScoreCategory.Chance,
            ScoreCategory.Yatzy
        };
    }
}
