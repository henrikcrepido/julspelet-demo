@page "/game"
@using Julspelet.Services
@using Julspelet.Models
@inject GameService GameService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

@* 
    Game Component - Main gameplay page for Yatzy
    Handles dice rolling, holding dice, scoring, and turn progression.
    Demonstrates Blazor's component lifecycle and state management.
*@

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (!GameService.GameState.IsGameStarted)
    {
        @* Redirect to home if game hasn't started *@
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            No game in progress. Redirecting to player setup...
        </MudAlert>
    }
    else if (GameService.GameState.IsGameComplete)
    {
        @* Game Over Screen *@
        <MudPaper Elevation="3" Class="pa-6 text-center">
            <MudText Typo="Typo.h3" Color="Color.Success" Class="mb-4">
                üéÑ Game Over! üéÖ
            </MudText>
            
            @{
                var winners = GameService.GameState.GetWinners();
                if (winners.Count == 1)
                {
                    <MudText Typo="Typo.h4" Class="mb-4">
                        üèÜ Winner: @winners[0].Name with @winners[0].TotalScore points! üèÜ
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.h4" Class="mb-4">
                        üèÜ It's a tie! üèÜ
                    </MudText>
                    <MudText Typo="Typo.h6" Class="mb-4">
                        Winners: @string.Join(", ", winners.Select(w => w.Name)) with @winners[0].TotalScore points each!
                    </MudText>
                }
            }

            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Size="Size.Large"
                       OnClick="NewGame"
                       StartIcon="@Icons.Material.Filled.Refresh">
                New Game
            </MudButton>
        </MudPaper>
    }
    else
    {
        @* Main Game Interface *@
        <MudGrid>
            @* Left Column - Game Area *@
            <MudItem xs="12" md="8">
                @* Current Player Info *@
                <MudPaper Elevation="3" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h5" Color="Color.Primary">
                        Current Turn: @GameService.GameState.GetCurrentPlayer()?.Name
                    </MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        Roll @GameService.GameState.RollsThisTurn of @GameState.MaxRollsPerTurn
                    </MudText>
                </MudPaper>

                @* Dice Display *@
                <MudPaper Elevation="3" Class="pa-6 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-4 text-center">Dice</MudText>
                    
                    <div class="dice-container">
                        @for (int i = 0; i < GameService.GameState.DiceSet.Dice.Count; i++)
                        {
                            var index = i; // Capture for lambda
                            var die = GameService.GameState.DiceSet.Dice[i];
                            var canHold = GameService.GameState.RollsThisTurn > 0 && 
                                         GameService.GameState.RollsThisTurn < GameState.MaxRollsPerTurn;

                            <div class="dice-wrapper">
                                <MudPaper Elevation="@(die.IsHeld ? 8 : 2)" 
                                          Class="@GetDiceClass(die)"
                                          @onclick="@(() => ToggleDie(index))"
                                          Style="@(canHold ? "cursor: pointer;" : "cursor: default;")">
                                    <div class="dice-value">
                                        @GetDiceEmoji(die.Value)
                                    </div>
                                </MudPaper>
                                @if (die.IsHeld)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mt-2">Held</MudChip>
                                }
                            </div>
                        }
                    </div>

                    @if (GameService.GameState.RollsThisTurn > 0)
                    {
                        <MudText Typo="Typo.caption" Class="text-center mt-3" Color="Color.Info">
                            Click on dice to hold them before your next roll
                        </MudText>
                    }
                </MudPaper>

                @* Action Buttons *@
                <MudPaper Elevation="3" Class="pa-4">
                    <div class="d-flex gap-3">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   Size="Size.Large"
                                   FullWidth="true"
                                   OnClick="RollDice"
                                   Disabled="!GameService.GameState.CanRoll()"
                                   StartIcon="@Icons.Material.Filled.Casino">
                            @(GameService.GameState.RollsThisTurn == 0 ? "Start Turn" : "Roll Again")
                        </MudButton>
                    </div>
                    
                    @if (!GameService.GameState.CanRoll() && GameService.GameState.RollsThisTurn > 0)
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-3">
                            No more rolls! Choose a category to score.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            @* Right Column - Scoring Interface *@
            <MudItem xs="12" md="4">
                @* Available Categories *@
                @if (GameService.GameState.RollsThisTurn > 0)
                {
                    <MudPaper Elevation="3" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h6" Class="mb-3">Score This Turn</MudText>
                        
                        @{
                            var availableCategories = GameService.GetAvailableCategories();
                            var currentPlayer = GameService.GameState.GetCurrentPlayer();
                        }

                        @if (availableCategories.Any())
                        {
                            <MudList T="string" Dense="true">
                                @foreach (var category in availableCategories)
                                {
                                    var potentialScore = GameService.GetPotentialScore(category);
                                    
                                    <MudListItem T="string" OnClick="@(() => SubmitScore(category))">
                                        <div class="d-flex justify-space-between align-center">
                                            <MudText Typo="Typo.body2">@category.GetDisplayName()</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="@(potentialScore > 0 ? Color.Success : Color.Default)">
                                                @potentialScore pts
                                            </MudChip>
                                        </div>
                                    </MudListItem>
                                    <MudDivider />
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">
                                All categories have been scored!
                            </MudAlert>
                        }
                    </MudPaper>
                }

                @* Current Player Scorecard *@
                <MudPaper Elevation="3" Class="pa-4 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        @GameService.GameState.GetCurrentPlayer()?.Name's Scorecard
                    </MudText>
                    
                    @{
                        var player = GameService.GameState.GetCurrentPlayer();
                        if (player != null)
                        {
                            <MudSimpleTable Dense="true" Hover="true" Class="scorecard-table">
                                <tbody>
                                    @* Upper Section *@
                                    <tr class="section-header">
                                        <td colspan="2"><strong>Upper Section</strong></td>
                                    </tr>
                                    @foreach (var category in GetUpperCategories())
                                    {
                                        <tr>
                                            <td>@category.GetDisplayName()</td>
                                            <td class="text-right">
                                                @if (player.ScoreCard.IsCategoryScored(category))
                                                {
                                                    <strong>@player.ScoreCard.Scores[category]</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                    <tr class="subtotal-row">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetUpperSectionTotal()</strong></td>
                                    </tr>
                                    <tr class="bonus-row">
                                        <td><strong>Bonus (63+)</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetUpperSectionBonus()</strong></td>
                                    </tr>

                                    @* Lower Section *@
                                    <tr class="section-header">
                                        <td colspan="2"><strong>Lower Section</strong></td>
                                    </tr>
                                    @foreach (var category in GetLowerCategories())
                                    {
                                        <tr>
                                            <td>@category.GetDisplayName()</td>
                                            <td class="text-right">
                                                @if (player.ScoreCard.IsCategoryScored(category))
                                                {
                                                    <strong>@player.ScoreCard.Scores[category]</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                    <tr class="subtotal-row">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right"><strong>@player.ScoreCard.GetLowerSectionTotal()</strong></td>
                                    </tr>

                                    @* Total *@
                                    <tr class="total-row">
                                        <td><strong>TOTAL</strong></td>
                                        <td class="text-right"><strong>@player.TotalScore</strong></td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                    }
                </MudPaper>

                @* All Players Scores *@
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">All Players</MudText>
                    
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th class="text-right">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var player in GameService.GameState.Players.OrderByDescending(p => p.TotalScore))
                            {
                                <tr class="@(player.IsCurrentTurn ? "current-player-row" : "")">
                                    <td>
                                        @if (player.IsCurrentTurn)
                                        {
                                            <strong>‚ñ∂ @player.Name</strong>
                                        }
                                        else
                                        {
                                            @player.Name
                                        }
                                    </td>
                                    <td class="text-right">
                                        <strong>@player.TotalScore</strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .dice-container {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin: 1rem 0;
    }

    .dice-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .dice {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: white;
    }

    .dice-held {
        background: #fff3cd !important;
        border: 3px solid #ffc107;
    }

    .dice:hover {
        transform: scale(1.05);
    }

    .dice-value {
        font-size: 3rem;
        user-select: none;
    }

    .scorecard-table {
        font-size: 0.875rem;
    }

    .scorecard-table td {
        padding: 0.5rem;
    }

    .section-header {
        background: #f5f5f5;
    }

    .subtotal-row {
        border-top: 1px solid #ddd;
        background: #fafafa;
    }

    .bonus-row {
        background: #fff3cd;
    }

    .total-row {
        border-top: 2px solid #333;
        background: #e3f2fd;
        font-size: 1.1rem;
    }

    .current-player-row {
        background: #e8f5e9;
        font-weight: 500;
    }

    .text-muted {
        color: #999;
    }
</style>

@code {
    /// <summary>
    /// Subscribes to game state changes when component initializes.
    /// This ensures the UI updates automatically when the game state changes.
    /// Also redirects to home if no game is in progress.
    /// </summary>
    protected override void OnInitialized()
    {
        if (!GameService.GameState.IsGameStarted)
        {
            Navigation.NavigateTo("/");
        }
        GameService.OnGameStateChanged += StateHasChanged;
    }

    /// <summary>
    /// Unsubscribes from events when component is disposed to prevent memory leaks.
    /// </summary>
    public void Dispose()
    {
        GameService.OnGameStateChanged -= StateHasChanged;
    }

    /// <summary>
    /// Rolls the dice for the current turn.
    /// </summary>
    private void RollDice()
    {
        GameService.RollDice();
    }

    /// <summary>
    /// Toggles the hold state of a die.
    /// </summary>
    private void ToggleDie(int index)
    {
        // Can only hold dice after first roll and before last roll is complete
        if (GameService.GameState.RollsThisTurn > 0 && 
            GameService.GameState.RollsThisTurn < GameState.MaxRollsPerTurn)
        {
            GameService.ToggleDieHold(index);
        }
    }

    /// <summary>
    /// Gets the CSS class for a die based on its held state.
    /// </summary>
    private string GetDiceClass(Die die)
    {
        return die.IsHeld ? "dice dice-held" : "dice";
    }

    /// <summary>
    /// Returns an emoji representation of the die value.
    /// Uses actual die face emojis for visual appeal.
    /// </summary>
    private string GetDiceEmoji(int value)
    {
        return value switch
        {
            1 => "‚öÄ",
            2 => "‚öÅ",
            3 => "‚öÇ",
            4 => "‚öÉ",
            5 => "‚öÑ",
            6 => "‚öÖ",
            _ => "?"
        };
    }

    /// <summary>
    /// Starts a new game and navigates back to player setup.
    /// </summary>
    private void NewGame()
    {
        GameService.NewGame();
        Navigation.NavigateTo("/");
    }

    /// <summary>
    /// Scores the selected category and moves to next player.
    /// </summary>
    private void SubmitScore(ScoreCategory category)
    {
        GameService.ScoreCategory(category);
    }

    /// <summary>
    /// Gets the upper section categories (Ones through Sixes).
    /// </summary>
    private List<ScoreCategory> GetUpperCategories()
    {
        return new List<ScoreCategory>
        {
            ScoreCategory.Ones,
            ScoreCategory.Twos,
            ScoreCategory.Threes,
            ScoreCategory.Fours,
            ScoreCategory.Fives,
            ScoreCategory.Sixes
        };
    }

    /// <summary>
    /// Gets the lower section categories (combinations).
    /// </summary>
    private List<ScoreCategory> GetLowerCategories()
    {
        return new List<ScoreCategory>
        {
            ScoreCategory.OnePair,
            ScoreCategory.TwoPairs,
            ScoreCategory.ThreeOfAKind,
            ScoreCategory.FourOfAKind,
            ScoreCategory.SmallStraight,
            ScoreCategory.LargeStraight,
            ScoreCategory.FullHouse,
            ScoreCategory.Chance,
            ScoreCategory.Yatzy
        };
    }
}
