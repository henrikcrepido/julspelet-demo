@page "/tournament-lobby"
@page "/tournament-lobby/{tournamentId}"
@using Julspelet.Models
@using Julspelet.Services
@inject TournamentService TournamentService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Tournament Lobby - Julspelet</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-6" Style="background: linear-gradient(135deg, #8b0000 0%, #dc143c 100%);">
        <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Warning" Class="mb-2" Style="font-family: 'Mountains of Christmas', cursive;">
            ğŸ„ Christmas Yatzy Tournaments ğŸ„
        </MudText>
        <MudText Typo="Typo.h6" Align="Align.Center" Style="color: #fffacd;">
            Join a tournament or create your own!
        </MudText>
    </MudPaper>

    <MudGrid Class="mt-4">
        <MudItem xs="12" md="4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.Add"
                       FullWidth="true"
                       OnClick="CreateNewTournament">
                Create Tournament (Game Master)
            </MudButton>
        </MudItem>
        
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-4" Style="background-color: rgba(255, 248, 220, 0.95);">
                <MudText Typo="Typo.body2" Color="Color.Dark">
                    <strong>ğŸ… Game Master:</strong> Create and manage tournaments<br/>
                    <strong>ğŸ Players:</strong> Join available tournaments below
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4" CloseIconClicked="ClearError" ShowCloseIcon="true">
            @_errorMessage
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <MudAlert Severity="Severity.Success" Class="mt-4" CloseIconClicked="ClearSuccess" ShowCloseIcon="true">
            @_successMessage
        </MudAlert>
    }

    <!-- Available Tournaments -->
    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">
            ğŸ† Available Tournaments
        </MudText>

        @if (_availableTournaments.Any())
        {
            <MudGrid>
                @foreach (var tournament in _availableTournaments)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Outlined="true" Style="border: 2px solid #2d5a2f;">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                                    ğŸ„ @tournament.Name
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <strong>Game Master:</strong> @tournament.GameMaster.Name
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <strong>Players:</strong> @tournament.RegisteredPlayers.Count / @tournament.MaxPlayers
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Status:</strong> 
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">Waiting for Players</MudChip>
                                </MudText>

                                @if (tournament.RegisteredPlayers.Any())
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info" Class="mb-2">
                                        Joined: @string.Join(", ", tournament.RegisteredPlayers.Select(p => p.Name))
                                    </MudText>
                                }
                            </MudCardContent>
                            
                            <MudCardActions>
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Success"
                                           StartIcon="@Icons.Material.Filled.PersonAdd"
                                           OnClick="@(() => ShowJoinDialog(tournament))"
                                           FullWidth="true">
                                    Join Tournament
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudAlert Severity="Severity.Info">
                No tournaments available. Be the first to create one!
            </MudAlert>
        }
    </MudPaper>

    <!-- Active/Ongoing Tournaments -->
    @if (_activeTournaments.Any())
    {
        <MudPaper Elevation="2" Class="pa-6 mt-4">
            <MudText Typo="Typo.h5" Color="Color.Secondary" Class="mb-4">
                ğŸ® Active Tournaments
            </MudText>

            <MudGrid>
                @foreach (var tournament in _activeTournaments)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Outlined="true" Style="border: 2px solid #1976d2;">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">
                                    ğŸ„ @tournament.Name
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <strong>Round:</strong> @tournament.CurrentRound
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Players:</strong> @tournament.RegisteredPlayers.Count
                                </MudText>

                                <MudChip T="string" Size="Size.Small" Color="Color.Info">In Progress</MudChip>
                            </MudCardContent>
                            
                            <MudCardActions>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           OnClick="@(() => ViewTournament(tournament.Id))"
                                           FullWidth="true">
                                    View Bracket
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    }
</MudContainer>

@if (_showJoinDialog && _selectedTournament != null)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" @onclick="CloseJoinDialog">
        <div style="background: white; padding: 24px; border-radius: 8px; min-width: 400px;" @onclick:stopPropagation="true">
            <MudText Typo="Typo.h6" Class="mb-4">
                ğŸ… Join Tournament: @_selectedTournament.Name
            </MudText>
            
            <MudTextField @bind-Value="_playerName" 
                          Label="Your Name" 
                          Variant="Variant.Outlined"
                          Required="true"
                          HelperText="Enter your name to join the tournament"
                          Class="mb-4" />
            
            <div class="d-flex justify-end gap-2">
                <MudButton OnClick="CloseJoinDialog" Color="Color.Default">Cancel</MudButton>
                <MudButton OnClick="JoinTournament" 
                           Color="Color.Success" 
                           Variant="Variant.Filled"
                           Disabled="@string.IsNullOrWhiteSpace(_playerName)">
                    Join
                </MudButton>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? TournamentId { get; set; }

    private List<Tournament> _availableTournaments = new();
    private List<Tournament> _activeTournaments = new();
    private string _errorMessage = "";
    private string _successMessage = "";
    private System.Threading.Timer? _refreshTimer;
    
    // Join dialog
    private bool _showJoinDialog;
    private Tournament? _selectedTournament;
    private string _playerName = "";

    protected override void OnInitialized()
    {
        LoadTournaments();
        
        // Subscribe to tournament events
        TournamentService.TournamentCreated += OnTournamentCreated;
        TournamentService.PlayerJoined += OnPlayerJoined;
        TournamentService.TournamentStarted += OnTournamentStarted;
        
        // Auto-refresh every 3 seconds
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                LoadTournaments();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    /// <summary>
    /// Called when route parameters are set or changed.
    /// If a tournament ID is provided in the URL, automatically show the join dialog.
    /// This enables direct joining via QR code or shared link.
    /// </summary>
    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(TournamentId))
        {
            // Find the tournament and show join dialog
            var tournament = TournamentService.GetTournament(TournamentId);
            if (tournament != null && tournament.IsAcceptingPlayers)
            {
                ShowJoinDialog(tournament);
            }
            else if (tournament != null)
            {
                _errorMessage = "This tournament is no longer accepting players.";
            }
            else
            {
                _errorMessage = "Tournament not found.";
            }
        }
    }

    private void LoadTournaments()
    {
        var allTournaments = TournamentService.GetAllTournaments();
        _availableTournaments = allTournaments.Where(t => t.IsAcceptingPlayers).ToList();
        _activeTournaments = allTournaments.Where(t => t.HasStarted && !t.IsCompleted).ToList();
    }

    private void CreateNewTournament()
    {
        NavigationManager.NavigateTo("/create-tournament");
    }

    private void ShowJoinDialog(Tournament tournament)
    {
        _selectedTournament = tournament;
        _playerName = "";
        _showJoinDialog = true;
        _errorMessage = "";
    }

    private void CloseJoinDialog()
    {
        _showJoinDialog = false;
        _selectedTournament = null;
        _playerName = "";
    }

    private void JoinTournament()
    {
        if (_selectedTournament == null || string.IsNullOrWhiteSpace(_playerName))
        {
            return;
        }

        var success = TournamentService.JoinTournament(_selectedTournament.Id, _playerName.Trim());
        
        if (success)
        {
            _successMessage = $"Successfully joined {_selectedTournament.Name}!";
            CloseJoinDialog();
            LoadTournaments();
        }
        else
        {
            _errorMessage = "Failed to join tournament. Name might already be taken or tournament is full.";
        }
    }

    private void ViewTournament(string tournamentId)
    {
        NavigationManager.NavigateTo($"/tournament-bracket/{tournamentId}");
    }

    private void ClearError()
    {
        _errorMessage = "";
    }

    private void ClearSuccess()
    {
        _successMessage = "";
    }

    private void OnTournamentCreated(Tournament tournament)
    {
        InvokeAsync(() =>
        {
            LoadTournaments();
            StateHasChanged();
        });
    }

    private void OnPlayerJoined(Tournament tournament, Player player)
    {
        InvokeAsync(() =>
        {
            LoadTournaments();
            StateHasChanged();
        });
    }

    private void OnTournamentStarted(Tournament tournament)
    {
        InvokeAsync(() =>
        {
            LoadTournaments();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        TournamentService.TournamentCreated -= OnTournamentCreated;
        TournamentService.PlayerJoined -= OnPlayerJoined;
        TournamentService.TournamentStarted -= OnTournamentStarted;
    }
}
